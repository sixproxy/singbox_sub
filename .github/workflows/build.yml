name: Build Multi-Platform Binaries

on:
  workflow_dispatch:
  push:
    tags: [ 'v*' ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux
          - goos: linux
            goarch: amd64
            output: sub
          - goos: linux
            goarch: arm64
            output: sub

          # Windows
          - goos: windows
            goarch: amd64
            output: sub.exe

          # macOS
          - goos: darwin
            goarch: arm64
            output: sub

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: |
          go test ./src/github.com/sixproxy/protocol -v
          go test ./src/github.com/sixproxy/model -v

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: 0
        run: |
          mkdir -p dist
          
          # æå–ç‰ˆæœ¬å·å’Œæ„å»ºæ—¶é—´
          VERSION="${{ github.ref_name }}"
          if [[ "$VERSION" == "refs/heads/"* ]]; then
            VERSION="${{ github.sha }}"
          fi
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # æ„å»ºå¸¦ç‰ˆæœ¬ä¿¡æ¯çš„äºŒè¿›åˆ¶
          go build -v -trimpath \
            -ldflags="-s -w -X 'singbox_sub/src/github.com/sixproxy/version.VERSION=$VERSION' -X 'singbox_sub/src/github.com/sixproxy/version.buildTime=$BUILD_TIME'" \
            -o dist/${{ matrix.output }} ./src/github.com/sixproxy/sub.go

      # æ–°å¢ï¼šæŠŠäºŒè¿›åˆ¶é‡å‘½åä¸ºå”¯ä¸€åå­—ï¼Œé˜²æ­¢ artifact ç›¸äº’è¦†ç›–
      - name: Rename binary with platform suffix for artifact
        run: |
          suffix="${{ matrix.goos }}-${{ matrix.goarch }}"
          if [ -n "${{ matrix.goarm }}" ]; then suffix="${suffix}v${{ matrix.goarm }}"; fi
          mv dist/${{ matrix.output }} dist/sub_${suffix}${{ endsWith(matrix.output, '.exe') && '.exe' || '' }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sub_${{ matrix.goos }}_${{ matrix.goarch }}${{ matrix.goarm && 'v' }}${{ matrix.goarm }}${{ endsWith(matrix.output, '.exe') && '.exe' || '' }}
          path: dist/*
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f -name "sub_*" -exec cp {} release/ \;

          # å¤åˆ¶ config ç›®å½•å’Œ bash è„šæœ¬ç›®å½•
          cp -r config release/
          cp -r bash release/

          # åœ¨ release ç›®å½•å†…ç”Ÿæˆæ ¡éªŒå’Œ
          cd release
          sha256sum sub_* > SHA256SUMS

          # ä¸ºæ¯ä¸ªå¹³å°å•ç‹¬æ‰“åŒ…
          for bin in sub_*; do
            platform="${bin#sub_}"  # å»æ‰å‰ç¼€
            platform="${platform%.exe}"  # å»æ‰ .exe åç¼€

            # åˆ›å»ºä¸´æ—¶ç›®å½•
            mkdir -p "$platform"
            cp "$bin" "$platform/"
            cp -r config "$platform/"
            cp -r bash "$platform/"
            
            # è®¾ç½® bash è„šæœ¬æ‰§è¡Œæƒé™ï¼ˆéWindowså¹³å°ï¼‰
            if [[ "$bin" != *.exe ]]; then
              chmod +x "$platform/bash/"*.sh
            fi

            if [[ "$bin" == *.exe ]]; then
              # Windows
              mv "$platform/$bin" "$platform/sub.exe"
              zip -r "sub-${platform}.zip" "$platform/"
            else
              # Linux / macOS / FreeBSD
              mv "$platform/$bin" "$platform/sub"
              tar -czf "sub-${platform}.tar.gz" "$platform/"
            fi

            # æ¸…ç†ä¸´æ—¶ç›®å½•
            rm -rf "$platform"
          done

          # åˆ é™¤åŸå§‹äºŒè¿›åˆ¶ï¼Œåªä¿ç•™å‹ç¼©åŒ…
          rm sub_*
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'rc') || contains(github.ref, 'alpha') }}
          generate_release_notes: true
          body: |
            ## ğŸš€ Release ${{ github.ref_name }}

            ### ğŸ“¦ Binaries
            - **Linux**: amd64, arm64, 386, armv7
            - **Windows**: amd64, 386, arm64
            - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
            - **FreeBSD**: amd64, 386

            ### ğŸ“‚ Package Contents
            ä¸‹è½½å‹ç¼©åŒ…åï¼Œå°†åŒ…å«ï¼š
            - äºŒè¿›åˆ¶æ–‡ä»¶ `sub`ï¼ˆæˆ– Windows ä¸‹çš„ `sub.exe`ï¼‰
            - é¡¹ç›®å†…ç½®çš„ `config` ç›®å½•ï¼ˆå«ç¤ºä¾‹é…ç½®ï¼‰
            - Linux è‡ªåŠ¨åŒ–è„šæœ¬ `bash` ç›®å½•ï¼ˆå«å¯åŠ¨/åœæ­¢è„šæœ¬ï¼‰

            ### ğŸ“‹ Usage
            1. ä¸‹è½½å¹¶è§£å‹å¯¹åº”å¹³å°å‹ç¼©åŒ…
            2. Linux/macOS æ‰§è¡Œ `chmod +x sub`ï¼ˆbashè„šæœ¬å·²è‡ªåŠ¨è®¾ç½®æ‰§è¡Œæƒé™ï¼‰
            3. è¿è¡Œ `./sub` å³å¯å¯åŠ¨
            4. Linuxç³»ç»Ÿä¼šè‡ªåŠ¨æ‰§è¡ŒæœåŠ¡ç®¡ç†å’Œé…ç½®éƒ¨ç½²

            ### ğŸ”’ Verification
            æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§ï¼š
            ```bash
            sha256sum -c SHA256SUMS
            ```

            ### ğŸ†• What's New
            è¯¦è§ GitHub æäº¤å†å²ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always() && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Notification
        run: |
          if [[ "${{ needs.build.result }}" == "success" && "${{ needs.release.result }}" == "success" ]]; then
            echo "âœ… Build and release completed successfully!"
            echo "ğŸ‰ New release ${{ github.ref_name }} is now available!"
          else
            echo "âŒ Build or release failed!"
            exit 1
          fi
